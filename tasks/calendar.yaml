- name: Allow HTTP from the proxy
  block:
    - name: Allow TCP on HTTP from the proxy
      become: true
      community.general.ufw:
        rule: allow
        direction: "{{ item }}"
        from_ip: "{{ http_proxy }}"
        port: 8080
        proto: tcp
      loop:
        - in
        - out

    - name: Allow UDP on HTTP from the proxy
      become: true
      community.general.ufw:
        rule: allow
        direction: "{{ item }}"
        from_ip: "{{ http_proxy }}"
        port: 8080
        proto: udp
      loop:
        - in
        - out

- name: Pull the calendar container
  containers.podman.podman_image:
    name: "{{ podman_image }}"

- name: Run the calendar container
  containers.podman.podman_container:
    name: unibocalendar
    image: "{{ podman_image }}"
    publish: 8080:8080
    state: started
    recreate: false

- name: Check if the calendar is up
  block:
    - name: Wait 5 seconds
      ansible.builtin.pause:
        seconds: 5
    - name: Check if the calendar is up
      ansible.builtin.uri:
        url: "{{ check_url }}"
